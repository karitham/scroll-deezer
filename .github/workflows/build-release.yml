name: Build and Release Extension

on:
  push:
    branches: [main]

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v27

      - name: Build and sign extension
        run: |
          nix develop --command bash -c "sed -i 's/\(\"version\": \"\)[^\"]*\(\".*\)/\11.0.${{ github.run_number }}\2/' manifest.json && web-ext sign --api-key ${{ secrets.AMO_API_KEY }} --api-secret ${{ secrets.AMO_API_SECRET }} --channel unlisted"
      - name: Get build date
        id: date
        run: echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create nightly release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ github.run_number }}
          name: Nightly Build ${{ github.run_number }}
          body: |
            Automated nightly build of Deezer Volume Scroll extension.

            Built from commit: ${{ github.sha }}
            Build date: ${{ steps.date.outputs.date }}
          files: web-ext-artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
